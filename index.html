<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Attendance Tracker</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-100 min-h-screen p-6">
<div class="max-w-7xl mx-auto">

<!-- Header -->
<div class="flex items-center justify-between mb-6">
  <div class="flex items-center gap-3">
    <img src="https://i.postimg.cc/NjskjGmv/Ridge-White-Logo.png" class="h-20" />
    <span class="text-xl font-semibold">Attendance Tracker</span>
  </div>
  <button onclick="openReport()" class="bg-slate-800 text-white px-4 py-2 rounded-lg text-sm">Report</button>
</div>

<!-- Controls -->
<div class="bg-white rounded-2xl shadow p-6 mb-6 grid md:grid-cols-5 gap-3">
<select id="name" class="border rounded-xl p-3">
<option value="">Select Employee</option>
<option>Aira</option><option>Hazel</option><option>AJ</option><option>James</option><option>Michael</option><option>Denmark</option><option>Randy</option>
</select>
<button onclick="login(this)" class="bg-emerald-700 hover:bg-emerald-800 text-white rounded-xl p-3">Login</button>
<button onclick="lunch(this)" class="bg-amber-500 hover:bg-amber-600 text-white rounded-xl p-3">Lunch</button>
<button onclick="breakTime(this)" class="bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl p-3">Break</button>
<button onclick="logout(this)" class="bg-rose-700 hover:bg-rose-800 text-white rounded-xl p-3">Logout</button>
</div>

<!-- Live Tracker -->
<div class="bg-white rounded-2xl shadow p-6 mb-6">
<h2 class="text-xl font-semibold mb-3">Live Tracker</h2>
<table class="w-full border text-sm">
<thead class="bg-slate-200">
<tr>
<th class="border p-2">Name</th>
<th class="border p-2">Shift</th>
<th class="border p-2">Login</th>
<th class="border p-2">Logout</th>
<th class="border p-2">Total Hours</th>
<th class="border p-2">Last Click</th>
<th class="border p-2">Status</th>
</tr>
</thead>
<tbody id="tableBody"></tbody>
</table>
</div>
</div>

<script>
const PASSWORD='Ridge2026!';
const REPORT_URL='https://docs.google.com/spreadsheets/d/12rFLpvuiD_OaAec8Mf9d0Wgpj5OUZAJVbThkNRu9xiY/edit?gid=1991191224#gid=1991191224';
const SHEET_POST_URL='https://script.google.com/macros/s/AKfycbxXPt4hfQ6LN25QkekfmU8bcTw1FY91-9uot_Y0P78dxEVevtTzHvVipkpBRj1C6tFJ/exec';
const SHEET_CSV_URL='https://docs.google.com/spreadsheets/d/e/2PACX-1vS-RNPfhsGqVtC7zn0DEpKs762RSBzCT1pKTW79C78gP97Fiz1Mk5H04K8PZ15gjwgRXvEiL6emgeTr/pub?gid=1991191224&single=true&output=csv';

const schedules={Aira:['09:00','18:00'],Hazel:['10:00','19:00'],AJ:['09:00','16:00'],James:['08:00','15:00'],Michael:['10:00','19:00'],Denmark:['10:00','20:00'],Randy:['12:00','21:00']};
window.cachedEvents={};

function estNow(){return new Date(new Date().toLocaleString('en-US',{timeZone:'America/New_York'}));}

function openReport(){const p=prompt('Enter password');if(p===PASSWORD)window.open(REPORT_URL,'_blank');else alert('Incorrect password');}

function pressEffect(btn){btn.classList.add('scale-95','shadow-inner','opacity-70');setTimeout(()=>btn.classList.remove('scale-95','shadow-inner','opacity-70'),400);}

function instantUpdate(name,type){
 if(!window.cachedEvents[name])window.cachedEvents[name]=[];
 window.cachedEvents[name].push({type:type,time:estNow()});
 render();
}

// ---- FIXED: form POST to avoid CORS ----
function postEvent(name,type,btn){
 if(!name){alert('Select employee');return}
 pressEffect(btn);
 instantUpdate(name,type);

 const payload={
   name:name,
   type:type,
   date:estNow().toLocaleDateString('en-US'),
   time:estNow().toISOString()
 };

 const form=document.createElement('form');
 form.method='POST';
 form.action=SHEET_POST_URL;
 form.target='hidden_iframe';

 const input=document.createElement('input');
 input.type='hidden';
 input.name='data';
 input.value=JSON.stringify(payload);

 form.appendChild(input);
 document.body.appendChild(form);
 form.submit();
 document.body.removeChild(form);
}

function login(btn){postEvent(document.getElementById('name').value,'Login',btn);} 
function lunch(btn){postEvent(document.getElementById('name').value,'Lunch',btn);} 
function breakTime(btn){postEvent(document.getElementById('name').value,'Break',btn);} 
function logout(btn){postEvent(document.getElementById('name').value,'Logout',btn);} 

function calcOnlineHours(ev){
 if(!ev||!ev.length)return '0.00';
 let total=0,start=null,onLunch=false;
 for(const e of ev){
  if(e.type==='Login')start=e.time;
  else if(e.type==='Lunch'&&start){if(!onLunch){total+=e.time-start;start=null;onLunch=true;}else{start=e.time;onLunch=false;}}
  else if(e.type==='Logout'&&start){total+=e.time-start;start=null;}
 }
 if(start)total+=estNow()-start;
 return (total/3600000).toFixed(2);
}

function deriveStatus(ev){
 if(!ev||!ev.length)return 'Offline';
 const last=ev[ev.length-1].type;
 if(last==='Logout')return 'Offline';
 if(last==='Break')return (ev.filter(x=>x.type==='Break').length%2)?'Quick Bio':'Online';
 if(last==='Lunch')return (ev.filter(x=>x.type==='Lunch').length%2)?'Lunch':'Online';
 if(last==='Login')return 'Online';
 return 'Online';
}

function render(){
 const body=document.getElementById('tableBody');
 body.innerHTML='';
 Object.keys(schedules).forEach(name=>{
  const ev=(window.cachedEvents[name]||[]);
  let login=null,logout=null,last=null;
  ev.forEach(e=>{if(e.type==='Login')login=e.time;if(e.type==='Logout')logout=e.time;last=e.time;});
  body.innerHTML+=`<tr>
<td class='border p-2'>${name}</td>
<td class='border p-2'>${schedules[name][0]}-${schedules[name][1]}</td>
<td class='border p-2'>${login?login.toLocaleTimeString('en-US',{timeZone:'America/New_York'}):'-'}</td>
<td class='border p-2'>${logout?logout.toLocaleTimeString('en-US',{timeZone:'America/New_York'}):'-'}</td>
<td class='border p-2'>${calcOnlineHours(ev)}</td>
<td class='border p-2'>${last?last.toLocaleTimeString('en-US',{timeZone:'America/New_York'}):'-'}</td>
<td class='border p-2'>${deriveStatus(ev)}</td>
</tr>`;
 });
}

async function load(){
 try{
  const res=await fetch(SHEET_CSV_URL+"&t="+Date.now());
  const text=await res.text();
  const rows=text.split('\n').slice(1).map(r=>r.split(','));
  const today=estNow().toLocaleDateString('en-US');
  let events={};
  rows.forEach(r=>{const n=r[0],t=r[1];if(!n||!r[3])return;const time=new Date(r[3]);const d=time.toLocaleDateString('en-US',{timeZone:'America/New_York'});if(d!==today)return;if(!events[n])events[n]=[];events[n].push({type:t,time});});
  window.cachedEvents=events;
  render();
 }catch(e){console.log('waiting logs');}
}

setInterval(render,2000);
load();
</script>

<iframe name="hidden_iframe" style="display:none"></iframe>
</body>
</html>
